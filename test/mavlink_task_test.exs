defmodule MAVLink.Test.Tasks do
  use ExUnit.Case
  import Mix.Tasks.Mavlink

  @input "#{File.cwd!()}/test/input/common.xml"
  @output_dir "#{File.cwd!()}/test/output"
  @output "#{@output_dir}/MAVLink.ex"
  @output_module "MAVLink"

  test "generate" do
    # Setup output directory
    File.mkdir_p(@output_dir)
    File.rm(@output)
    
    # Run mix task
    run([@input, @output, @output_module])
    
    # Did it generate
    assert File.exists?(@output)
    
    # We don't care if we redefine MAVLink modules while running the following test
    Code.compiler_options(ignore_module_conflict: true)

    # Confirm the list of modules generated from common.xml and its includes
    pairs =
      Enum.zip(
        [
          Elixir.MAVLink,
          Elixir.MAVLink.Message.ActuatorControlTarget,
          Elixir.MAVLink.Message.AdsbVehicle,
          Elixir.MAVLink.Message.Altitude,
          Elixir.MAVLink.Message.AttPosMocap,
          Elixir.MAVLink.Message.Attitude,
          Elixir.MAVLink.Message.AttitudeQuaternion,
          Elixir.MAVLink.Message.AttitudeQuaternionCov,
          Elixir.MAVLink.Message.AttitudeTarget,
          Elixir.MAVLink.Message.AuthKey,
          Elixir.MAVLink.Message.AutopilotVersion,
          Elixir.MAVLink.Message.BatteryStatus,
          Elixir.MAVLink.Message.ButtonChange,
          Elixir.MAVLink.Message.CameraCaptureStatus,
          Elixir.MAVLink.Message.CameraImageCaptured,
          Elixir.MAVLink.Message.CameraInformation,
          Elixir.MAVLink.Message.CameraSettings,
          Elixir.MAVLink.Message.CameraTrigger,
          Elixir.MAVLink.Message.ChangeOperatorControl,
          Elixir.MAVLink.Message.ChangeOperatorControlAck,
          Elixir.MAVLink.Message.Collision,
          Elixir.MAVLink.Message.CommandAck,
          Elixir.MAVLink.Message.CommandInt,
          Elixir.MAVLink.Message.CommandLong,
          Elixir.MAVLink.Message.ControlSystemState,
          Elixir.MAVLink.Message.DataStream,
          Elixir.MAVLink.Message.DataTransmissionHandshake,
          Elixir.MAVLink.Message.Debug,
          Elixir.MAVLink.Message.DebugFloatArray,
          Elixir.MAVLink.Message.DebugVect,
          Elixir.MAVLink.Message.DistanceSensor,
          Elixir.MAVLink.Message.EncapsulatedData,
          Elixir.MAVLink.Message.EstimatorStatus,
          Elixir.MAVLink.Message.ExtendedSysState,
          Elixir.MAVLink.Message.FileTransferProtocol,
          Elixir.MAVLink.Message.FlightInformation,
          Elixir.MAVLink.Message.FollowTarget,
          Elixir.MAVLink.Message.GlobalPositionInt,
          Elixir.MAVLink.Message.GlobalPositionIntCov,
          Elixir.MAVLink.Message.GlobalVisionPositionEstimate,
          Elixir.MAVLink.Message.Gps2Raw,
          Elixir.MAVLink.Message.Gps2Rtk,
          Elixir.MAVLink.Message.GpsGlobalOrigin,
          Elixir.MAVLink.Message.GpsInjectData,
          Elixir.MAVLink.Message.GpsInput,
          Elixir.MAVLink.Message.GpsRawInt,
          Elixir.MAVLink.Message.GpsRtcmData,
          Elixir.MAVLink.Message.GpsRtk,
          Elixir.MAVLink.Message.GpsStatus,
          Elixir.MAVLink.Message.Heartbeat,
          Elixir.MAVLink.Message.HighLatency,
          Elixir.MAVLink.Message.HighresImu,
          Elixir.MAVLink.Message.HilActuatorControls,
          Elixir.MAVLink.Message.HilControls,
          Elixir.MAVLink.Message.HilGps,
          Elixir.MAVLink.Message.HilOpticalFlow,
          Elixir.MAVLink.Message.HilRcInputsRaw,
          Elixir.MAVLink.Message.HilSensor,
          Elixir.MAVLink.Message.HilState,
          Elixir.MAVLink.Message.HilStateQuaternion,
          Elixir.MAVLink.Message.HomePosition,
          Elixir.MAVLink.Message.LandingTarget,
          Elixir.MAVLink.Message.LocalPositionNed,
          Elixir.MAVLink.Message.LocalPositionNedCov,
          Elixir.MAVLink.Message.LocalPositionNedSystemGlobalOffset,
          Elixir.MAVLink.Message.LogData,
          Elixir.MAVLink.Message.LogEntry,
          Elixir.MAVLink.Message.LogErase,
          Elixir.MAVLink.Message.LogRequestData,
          Elixir.MAVLink.Message.LogRequestEnd,
          Elixir.MAVLink.Message.LogRequestList,
          Elixir.MAVLink.Message.LoggingAck,
          Elixir.MAVLink.Message.LoggingData,
          Elixir.MAVLink.Message.LoggingDataAcked,
          Elixir.MAVLink.Message.ManualControl,
          Elixir.MAVLink.Message.ManualSetpoint,
          Elixir.MAVLink.Message.MemoryVect,
          Elixir.MAVLink.Message.MessageInterval,
          Elixir.MAVLink.Message.MissionAck,
          Elixir.MAVLink.Message.MissionClearAll,
          Elixir.MAVLink.Message.MissionCount,
          Elixir.MAVLink.Message.MissionCurrent,
          Elixir.MAVLink.Message.MissionItem,
          Elixir.MAVLink.Message.MissionItemInt,
          Elixir.MAVLink.Message.MissionItemReached,
          Elixir.MAVLink.Message.MissionRequest,
          Elixir.MAVLink.Message.MissionRequestInt,
          Elixir.MAVLink.Message.MissionRequestList,
          Elixir.MAVLink.Message.MissionRequestPartialList,
          Elixir.MAVLink.Message.MissionSetCurrent,
          Elixir.MAVLink.Message.MissionWritePartialList,
          Elixir.MAVLink.Message.MountOrientation,
          Elixir.MAVLink.Message.NamedValueFloat,
          Elixir.MAVLink.Message.NamedValueInt,
          Elixir.MAVLink.Message.NavControllerOutput,
          Elixir.MAVLink.Message.ObstacleDistance,
          Elixir.MAVLink.Message.Odometry,
          Elixir.MAVLink.Message.OpticalFlow,
          Elixir.MAVLink.Message.OpticalFlowRad,
          Elixir.MAVLink.Message.ParamMapRc,
          Elixir.MAVLink.Message.ParamRequestList,
          Elixir.MAVLink.Message.ParamRequestRead,
          Elixir.MAVLink.Message.ParamSet,
          Elixir.MAVLink.Message.ParamValue,
          Elixir.MAVLink.Message.Ping,
          Elixir.MAVLink.Message.PlayTune,
          Elixir.MAVLink.Message.PositionTargetGlobalInt,
          Elixir.MAVLink.Message.PositionTargetLocalNed,
          Elixir.MAVLink.Message.PowerStatus,
          Elixir.MAVLink.Message.RadioStatus,
          Elixir.MAVLink.Message.RawImu,
          Elixir.MAVLink.Message.RawPressure,
          Elixir.MAVLink.Message.RcChannels,
          Elixir.MAVLink.Message.RcChannelsOverride,
          Elixir.MAVLink.Message.RcChannelsRaw,
          Elixir.MAVLink.Message.RcChannelsScaled,
          Elixir.MAVLink.Message.RequestDataStream,
          Elixir.MAVLink.Message.ResourceRequest,
          Elixir.MAVLink.Message.SafetyAllowedArea,
          Elixir.MAVLink.Message.SafetySetAllowedArea,
          Elixir.MAVLink.Message.ScaledImu,
          Elixir.MAVLink.Message.ScaledImu2,
          Elixir.MAVLink.Message.ScaledImu3,
          Elixir.MAVLink.Message.ScaledPressure,
          Elixir.MAVLink.Message.ScaledPressure2,
          Elixir.MAVLink.Message.ScaledPressure3,
          Elixir.MAVLink.Message.SerialControl,
          Elixir.MAVLink.Message.ServoOutputRaw,
          Elixir.MAVLink.Message.SetActuatorControlTarget,
          Elixir.MAVLink.Message.SetAttitudeTarget,
          Elixir.MAVLink.Message.SetGpsGlobalOrigin,
          Elixir.MAVLink.Message.SetHomePosition,
          Elixir.MAVLink.Message.SetMode,
          Elixir.MAVLink.Message.SetPositionTargetGlobalInt,
          Elixir.MAVLink.Message.SetPositionTargetLocalNed,
          Elixir.MAVLink.Message.SetupSigning,
          Elixir.MAVLink.Message.SimState,
          Elixir.MAVLink.Message.Statustext,
          Elixir.MAVLink.Message.StatustextLong,
          Elixir.MAVLink.Message.StorageInformation,
          Elixir.MAVLink.Message.SysStatus,
          Elixir.MAVLink.Message.SystemTime,
          Elixir.MAVLink.Message.TerrainCheck,
          Elixir.MAVLink.Message.TerrainData,
          Elixir.MAVLink.Message.TerrainReport,
          Elixir.MAVLink.Message.TerrainRequest,
          Elixir.MAVLink.Message.Timesync,
          Elixir.MAVLink.Message.UavcanNodeInfo,
          Elixir.MAVLink.Message.UavcanNodeStatus,
          Elixir.MAVLink.Message.V2Extension,
          Elixir.MAVLink.Message.VfrHud,
          Elixir.MAVLink.Message.Vibration,
          Elixir.MAVLink.Message.ViconPositionEstimate,
          Elixir.MAVLink.Message.VisionPositionEstimate,
          Elixir.MAVLink.Message.VisionSpeedEstimate,
          Elixir.MAVLink.Message.WheelDistance,
          Elixir.MAVLink.Message.WifiConfigAp,
          Elixir.MAVLink.Message.WindCov,
          Elixir.MAVLink.Pack,
          Elixir.MAVLink.Pack.Atom,
          Elixir.MAVLink.Pack.BitString,
          Elixir.MAVLink.Pack.Float,
          Elixir.MAVLink.Pack.Function,
          Elixir.MAVLink.Pack.Integer,
          Elixir.MAVLink.Pack.List,
          Elixir.MAVLink.Pack.MAVLink.Message.ActuatorControlTarget,
          Elixir.MAVLink.Pack.MAVLink.Message.AdsbVehicle,
          Elixir.MAVLink.Pack.MAVLink.Message.Altitude,
          Elixir.MAVLink.Pack.MAVLink.Message.AttPosMocap,
          Elixir.MAVLink.Pack.MAVLink.Message.Attitude,
          Elixir.MAVLink.Pack.MAVLink.Message.AttitudeQuaternion,
          Elixir.MAVLink.Pack.MAVLink.Message.AttitudeQuaternionCov,
          Elixir.MAVLink.Pack.MAVLink.Message.AttitudeTarget,
          Elixir.MAVLink.Pack.MAVLink.Message.AuthKey,
          Elixir.MAVLink.Pack.MAVLink.Message.AutopilotVersion,
          Elixir.MAVLink.Pack.MAVLink.Message.BatteryStatus,
          Elixir.MAVLink.Pack.MAVLink.Message.ButtonChange,
          Elixir.MAVLink.Pack.MAVLink.Message.CameraCaptureStatus,
          Elixir.MAVLink.Pack.MAVLink.Message.CameraImageCaptured,
          Elixir.MAVLink.Pack.MAVLink.Message.CameraInformation,
          Elixir.MAVLink.Pack.MAVLink.Message.CameraSettings,
          Elixir.MAVLink.Pack.MAVLink.Message.CameraTrigger,
          Elixir.MAVLink.Pack.MAVLink.Message.ChangeOperatorControl,
          Elixir.MAVLink.Pack.MAVLink.Message.ChangeOperatorControlAck,
          Elixir.MAVLink.Pack.MAVLink.Message.Collision,
          Elixir.MAVLink.Pack.MAVLink.Message.CommandAck,
          Elixir.MAVLink.Pack.MAVLink.Message.CommandInt,
          Elixir.MAVLink.Pack.MAVLink.Message.CommandLong,
          Elixir.MAVLink.Pack.MAVLink.Message.ControlSystemState,
          Elixir.MAVLink.Pack.MAVLink.Message.DataStream,
          Elixir.MAVLink.Pack.MAVLink.Message.DataTransmissionHandshake,
          Elixir.MAVLink.Pack.MAVLink.Message.Debug,
          Elixir.MAVLink.Pack.MAVLink.Message.DebugFloatArray,
          Elixir.MAVLink.Pack.MAVLink.Message.DebugVect,
          Elixir.MAVLink.Pack.MAVLink.Message.DistanceSensor,
          Elixir.MAVLink.Pack.MAVLink.Message.EncapsulatedData,
          Elixir.MAVLink.Pack.MAVLink.Message.EstimatorStatus,
          Elixir.MAVLink.Pack.MAVLink.Message.ExtendedSysState,
          Elixir.MAVLink.Pack.MAVLink.Message.FileTransferProtocol,
          Elixir.MAVLink.Pack.MAVLink.Message.FlightInformation,
          Elixir.MAVLink.Pack.MAVLink.Message.FollowTarget,
          Elixir.MAVLink.Pack.MAVLink.Message.GlobalPositionInt,
          Elixir.MAVLink.Pack.MAVLink.Message.GlobalPositionIntCov,
          Elixir.MAVLink.Pack.MAVLink.Message.GlobalVisionPositionEstimate,
          Elixir.MAVLink.Pack.MAVLink.Message.Gps2Raw,
          Elixir.MAVLink.Pack.MAVLink.Message.Gps2Rtk,
          Elixir.MAVLink.Pack.MAVLink.Message.GpsGlobalOrigin,
          Elixir.MAVLink.Pack.MAVLink.Message.GpsInjectData,
          Elixir.MAVLink.Pack.MAVLink.Message.GpsInput,
          Elixir.MAVLink.Pack.MAVLink.Message.GpsRawInt,
          Elixir.MAVLink.Pack.MAVLink.Message.GpsRtcmData,
          Elixir.MAVLink.Pack.MAVLink.Message.GpsRtk,
          Elixir.MAVLink.Pack.MAVLink.Message.GpsStatus,
          Elixir.MAVLink.Pack.MAVLink.Message.Heartbeat,
          Elixir.MAVLink.Pack.MAVLink.Message.HighLatency,
          Elixir.MAVLink.Pack.MAVLink.Message.HighresImu,
          Elixir.MAVLink.Pack.MAVLink.Message.HilActuatorControls,
          Elixir.MAVLink.Pack.MAVLink.Message.HilControls,
          Elixir.MAVLink.Pack.MAVLink.Message.HilGps,
          Elixir.MAVLink.Pack.MAVLink.Message.HilOpticalFlow,
          Elixir.MAVLink.Pack.MAVLink.Message.HilRcInputsRaw,
          Elixir.MAVLink.Pack.MAVLink.Message.HilSensor,
          Elixir.MAVLink.Pack.MAVLink.Message.HilState,
          Elixir.MAVLink.Pack.MAVLink.Message.HilStateQuaternion,
          Elixir.MAVLink.Pack.MAVLink.Message.HomePosition,
          Elixir.MAVLink.Pack.MAVLink.Message.LandingTarget,
          Elixir.MAVLink.Pack.MAVLink.Message.LocalPositionNed,
          Elixir.MAVLink.Pack.MAVLink.Message.LocalPositionNedCov,
          Elixir.MAVLink.Pack.MAVLink.Message.LocalPositionNedSystemGlobalOffset,
          Elixir.MAVLink.Pack.MAVLink.Message.LogData,
          Elixir.MAVLink.Pack.MAVLink.Message.LogEntry,
          Elixir.MAVLink.Pack.MAVLink.Message.LogErase,
          Elixir.MAVLink.Pack.MAVLink.Message.LogRequestData,
          Elixir.MAVLink.Pack.MAVLink.Message.LogRequestEnd,
          Elixir.MAVLink.Pack.MAVLink.Message.LogRequestList,
          Elixir.MAVLink.Pack.MAVLink.Message.LoggingAck,
          Elixir.MAVLink.Pack.MAVLink.Message.LoggingData,
          Elixir.MAVLink.Pack.MAVLink.Message.LoggingDataAcked,
          Elixir.MAVLink.Pack.MAVLink.Message.ManualControl,
          Elixir.MAVLink.Pack.MAVLink.Message.ManualSetpoint,
          Elixir.MAVLink.Pack.MAVLink.Message.MemoryVect,
          Elixir.MAVLink.Pack.MAVLink.Message.MessageInterval,
          Elixir.MAVLink.Pack.MAVLink.Message.MissionAck,
          Elixir.MAVLink.Pack.MAVLink.Message.MissionClearAll,
          Elixir.MAVLink.Pack.MAVLink.Message.MissionCount,
          Elixir.MAVLink.Pack.MAVLink.Message.MissionCurrent,
          Elixir.MAVLink.Pack.MAVLink.Message.MissionItem,
          Elixir.MAVLink.Pack.MAVLink.Message.MissionItemInt,
          Elixir.MAVLink.Pack.MAVLink.Message.MissionItemReached,
          Elixir.MAVLink.Pack.MAVLink.Message.MissionRequest,
          Elixir.MAVLink.Pack.MAVLink.Message.MissionRequestInt,
          Elixir.MAVLink.Pack.MAVLink.Message.MissionRequestList,
          Elixir.MAVLink.Pack.MAVLink.Message.MissionRequestPartialList,
          Elixir.MAVLink.Pack.MAVLink.Message.MissionSetCurrent,
          Elixir.MAVLink.Pack.MAVLink.Message.MissionWritePartialList,
          Elixir.MAVLink.Pack.MAVLink.Message.MountOrientation,
          Elixir.MAVLink.Pack.MAVLink.Message.NamedValueFloat,
          Elixir.MAVLink.Pack.MAVLink.Message.NamedValueInt,
          Elixir.MAVLink.Pack.MAVLink.Message.NavControllerOutput,
          Elixir.MAVLink.Pack.MAVLink.Message.ObstacleDistance,
          Elixir.MAVLink.Pack.MAVLink.Message.Odometry,
          Elixir.MAVLink.Pack.MAVLink.Message.OpticalFlow,
          Elixir.MAVLink.Pack.MAVLink.Message.OpticalFlowRad,
          Elixir.MAVLink.Pack.MAVLink.Message.ParamMapRc,
          Elixir.MAVLink.Pack.MAVLink.Message.ParamRequestList,
          Elixir.MAVLink.Pack.MAVLink.Message.ParamRequestRead,
          Elixir.MAVLink.Pack.MAVLink.Message.ParamSet,
          Elixir.MAVLink.Pack.MAVLink.Message.ParamValue,
          Elixir.MAVLink.Pack.MAVLink.Message.Ping,
          Elixir.MAVLink.Pack.MAVLink.Message.PlayTune,
          Elixir.MAVLink.Pack.MAVLink.Message.PositionTargetGlobalInt,
          Elixir.MAVLink.Pack.MAVLink.Message.PositionTargetLocalNed,
          Elixir.MAVLink.Pack.MAVLink.Message.PowerStatus,
          Elixir.MAVLink.Pack.MAVLink.Message.RadioStatus,
          Elixir.MAVLink.Pack.MAVLink.Message.RawImu,
          Elixir.MAVLink.Pack.MAVLink.Message.RawPressure,
          Elixir.MAVLink.Pack.MAVLink.Message.RcChannels,
          Elixir.MAVLink.Pack.MAVLink.Message.RcChannelsOverride,
          Elixir.MAVLink.Pack.MAVLink.Message.RcChannelsRaw,
          Elixir.MAVLink.Pack.MAVLink.Message.RcChannelsScaled,
          Elixir.MAVLink.Pack.MAVLink.Message.RequestDataStream,
          Elixir.MAVLink.Pack.MAVLink.Message.ResourceRequest,
          Elixir.MAVLink.Pack.MAVLink.Message.SafetyAllowedArea,
          Elixir.MAVLink.Pack.MAVLink.Message.SafetySetAllowedArea,
          Elixir.MAVLink.Pack.MAVLink.Message.ScaledImu,
          Elixir.MAVLink.Pack.MAVLink.Message.ScaledImu2,
          Elixir.MAVLink.Pack.MAVLink.Message.ScaledImu3,
          Elixir.MAVLink.Pack.MAVLink.Message.ScaledPressure,
          Elixir.MAVLink.Pack.MAVLink.Message.ScaledPressure2,
          Elixir.MAVLink.Pack.MAVLink.Message.ScaledPressure3,
          Elixir.MAVLink.Pack.MAVLink.Message.SerialControl,
          Elixir.MAVLink.Pack.MAVLink.Message.ServoOutputRaw,
          Elixir.MAVLink.Pack.MAVLink.Message.SetActuatorControlTarget,
          Elixir.MAVLink.Pack.MAVLink.Message.SetAttitudeTarget,
          Elixir.MAVLink.Pack.MAVLink.Message.SetGpsGlobalOrigin,
          Elixir.MAVLink.Pack.MAVLink.Message.SetHomePosition,
          Elixir.MAVLink.Pack.MAVLink.Message.SetMode,
          Elixir.MAVLink.Pack.MAVLink.Message.SetPositionTargetGlobalInt,
          Elixir.MAVLink.Pack.MAVLink.Message.SetPositionTargetLocalNed,
          Elixir.MAVLink.Pack.MAVLink.Message.SetupSigning,
          Elixir.MAVLink.Pack.MAVLink.Message.SimState,
          Elixir.MAVLink.Pack.MAVLink.Message.Statustext,
          Elixir.MAVLink.Pack.MAVLink.Message.StatustextLong,
          Elixir.MAVLink.Pack.MAVLink.Message.StorageInformation,
          Elixir.MAVLink.Pack.MAVLink.Message.SysStatus,
          Elixir.MAVLink.Pack.MAVLink.Message.SystemTime,
          Elixir.MAVLink.Pack.MAVLink.Message.TerrainCheck,
          Elixir.MAVLink.Pack.MAVLink.Message.TerrainData,
          Elixir.MAVLink.Pack.MAVLink.Message.TerrainReport,
          Elixir.MAVLink.Pack.MAVLink.Message.TerrainRequest,
          Elixir.MAVLink.Pack.MAVLink.Message.Timesync,
          Elixir.MAVLink.Pack.MAVLink.Message.UavcanNodeInfo,
          Elixir.MAVLink.Pack.MAVLink.Message.UavcanNodeStatus,
          Elixir.MAVLink.Pack.MAVLink.Message.V2Extension,
          Elixir.MAVLink.Pack.MAVLink.Message.VfrHud,
          Elixir.MAVLink.Pack.MAVLink.Message.Vibration,
          Elixir.MAVLink.Pack.MAVLink.Message.ViconPositionEstimate,
          Elixir.MAVLink.Pack.MAVLink.Message.VisionPositionEstimate,
          Elixir.MAVLink.Pack.MAVLink.Message.VisionSpeedEstimate,
          Elixir.MAVLink.Pack.MAVLink.Message.WheelDistance,
          Elixir.MAVLink.Pack.MAVLink.Message.WifiConfigAp,
          Elixir.MAVLink.Pack.MAVLink.Message.WindCov,
          Elixir.MAVLink.Pack.Map,
          Elixir.MAVLink.Pack.PID,
          Elixir.MAVLink.Pack.Port,
          Elixir.MAVLink.Pack.Reference,
          Elixir.MAVLink.Pack.Tuple
        ],
        Code.compile_file(@output)
        |> Keyword.keys()
        |> Enum.sort()
      )

    for {expected, actual} <- pairs do
      assert expected == actual
    end
  end
end
